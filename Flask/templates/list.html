<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <style>
        #dropfield {
            margin: 0;
            position: absolute;
            width: 19px;
            height: 10px;
        }
    </style>
</head>

<body onload="dostart()">
    <h1>Please enter your data</h1>

    <p id="first">
    <p id="fielddump" class="ffield"><input type="temptext" class="x1x1" onblur="con()" value="Vorname"><input
            type="temptext" class="x1x2" onblur="con()" value="Nachname"><input type="temptext" class="x1x3"
            onblur="con()" value="Mail-Addresse"><input type="temptext" class="x1x4" onblur="con()" value="Addresse">
    </p>
    <p id="secfielddump" class="secfield">
    <p id="field" class="field"></p>
    <p id="secfield" class="secfield"></p>
    </p>
    </p>
    <script>
        let backupArray = []
        let rowcount = 1
        let columncount = 4
        function addrow(mode) {
            if (mode == 'nor') { con() }
            rowcount++
            console.log('rowcount is ' + rowcount)
            content = ''
            for (let i = 1; i < columncount + 1; i++) {
                let unid = 'x' + rowcount + "x" + i
                let inp = '<input type="temptext" class="' + unid + '" onblur="con()">'
                content = content + inp
            }
            console.log(content)
            document.getElementById("field").innerHTML = content
            document.getElementById("field").classList = "ffield"
            document.getElementById("field").id = "fielddump"
            document.getElementById("secfield").innerHTML = '<p id="field" class="field"></p><p id = "tempfield" class ="secfield"></p>'
            document.getElementById("secfield").id = "secfielddump"
            document.getElementById("tempfield").id = "secfield"
            if (mode != 'hal') { loadArray('nor') }
        }
        function addcol(mode) {
            con()
            columncount++
            curdoc = document.querySelectorAll(".ffield")
            for (let ii = 1; ii < curdoc.length + 1; ii++) {
                mancoun = 1
                content = ''
                for (let i = 1; i < columncount + 1; i++) {
                    let unid = 'x' + ii + "x" + i
                    let inp = '<input type="temptext" class="' + unid + '" onblur="con()">'
                    content = content + inp
                }
                curdoc[ii - 1].innerHTML = content
                mancoun++
            }
            if (mode != 'kthar') { loadArray('nor') }
            con()
        }
        function delrow() {
            con()
            console.log('rowcount is ' + rowcount)
            if (rowcount > 2) {
                curdoc = document.querySelectorAll(".secfield")
                if (curdoc.length > 2) {
                    curcurdoc = curdoc[curdoc.length - 2]
                }
                else {
                    curcurdoc = curdoc[0]
                }
                curdocval = document.querySelectorAll(".ffield")
                curcurdocval = curdocval[curdocval.length - 1]
                console.log(curdocval + 'is curdocval')
                curcurdocval.innerHTML = ""
                curcurdocvalnew = curdocval[curdocval.length - 2]
                curcurdocvalnew.id = "field"

                console.log(curdoc)
                console.log(curcurdoc)
                curcurdoc.innerHTML = ""
                //curcurdoc.id="secfield"
                curcurdocnew = curdoc[curdoc.length - 3]
                curcurdocnew.id = "secfield"

                rowcount--
                rowcount--
                addrow('mor')
            }
            loadArray('row')
            con()
        }
        function delcol() {
            con()
            if (columncount > 1) {
                columncount--
                curdoc = document.querySelectorAll(".ffield")
                for (let ii = 1; ii < curdoc.length + 1; ii++) {
                    content = ''
                    for (let i = 1; i < columncount + 1; i++) {
                        unid = 'x' + ii + "x" + i
                        inp = '<input type="temptext" class="' + unid + '" onblur="con()">'
                        content = content + inp
                    }
                    console.log(content)
                    console.log(curdoc)
                    curdoc[ii - 1].innerHTML = content
                }
            }
            loadArray('col')
            con()
        }
        function dosmthfile(ev) {
            ev.preventDefault()
            dt = ev.dataTransfer;
            files = dt.files
            mainfile = files[0]
            console.log('Wenn das als File erkannt wird kommt hier was raus: ' + mainfile)
            console.log(mainfile)
            var xhr = new XMLHttpRequest();
            var url = "http://127.0.0.1:5000/fileinp";
            var method = 'POST';

            xhr.open(method, url);
            xhr.setRequestHeader('Access-Control-Allow-Origin', '*')
            xhr.setRequestHeader('Content-Type', 'FormData')
            xhr.onload = function () { console.log(this.response) };

            var formData = new FormData();
            formData.append(mainfile, File)

            xhr.send(formData);
        }
        function dosmthdragover(ev) {
            ev.preventDefault()
            console.log('dragging')
        }
        function usefile() {
            usefilepath = 'C:/Users/Noah/Downloads/myfile.txt'
            var xhr = new XMLHttpRequest();
            var url = "http://127.0.0.1:5000/fileinp";
            var method = 'POST';

            xhr.open(method, url);
            xhr.setRequestHeader('Access-Control-Allow-Origin', '*')
            xhr.setRequestHeader('Content-Type', 'application/json')
            xhr.onload = function () { oncollide(this.response) };

            let realdata = JSON.stringify(usefilepath)

            xhr.send(realdata);
        }
        function oncollide(response) {
            //inprowcount = response.length
            //inpcolumncount = response[0].length
            console.log(typeof response)
            console.log(response)
            //Weil Python ja nicht will: Hier bei einem " die Annahme beginnen und bei einem weiteren " die Annahme beenden(für den ganzen File)
            started = false
            currentString = ''
            fulllist = []
            timelist = []
            for (let i = 0; i < response.length; i++) {
                if (response[i] == '"') {
                    if (started == false) {
                        started = true
                    }
                    else {
                        if (currentString != 'endline') {
                            timelist.push(currentString)
                            currentString = ''
                            started = false
                        }
                        else {
                            fulllist.push(timelist)
                            currentString = ''
                            timelist = []
                            started = false
                        }
                    }
                }
                else if (started == true) {
                    currentString = currentString + response[i]
                }
            }
            loadmyArray(fulllist)
            con()
            console.log(fulllist)
        }
        function loadmyArray(array) {
            bua = array
            if (rowcount >= bua.length && columncount >= bua[0].length) {
                for (let i = 1; i < bua.length + 1; i++) {
                    for (let ii = 1; ii < bua[0].length + 1; ii++) {
                        loadid = 'x' + i + 'x' + ii
                        document.querySelectorAll('.' + loadid)[0].value = bua[i - 1][ii - 1]
                    }
                }
            }
            else {
                if (rowcount < bua.length) {
                    for (let i = bua.length - rowcount; i > 0; i--) {
                        addrow('hal')
                        console.log('row expanded')
                    }
                }
                if (columncount < bua[0].length) {
                    for (let i = bua[0].length - columncount; i > 0; i--) {
                        addcol('kthar')
                        console.log('column expanded')
                    }
                }
                loadmyArray(array)
            }
            con()
        }
        function datafile() {
            usefilepath = 'hentai'
            var xhr = new XMLHttpRequest();
            var url = "http://127.0.0.1:5000/d";
            var method = 'POST';

            xhr.open(method, url);
            xhr.setRequestHeader('Access-Control-Allow-Origin', '*')
            xhr.setRequestHeader('Content-Type', 'application/json')
            xhr.onload = function () { oncoll(this.response) };

            let realdata = JSON.stringify(usefilepath)

            xhr.send(realdata);
        }
        function oncoll(file)
        {
            console.log(typeof file)
            console.log(file)
        }
        function datasend(){
            dataArray = []
            for (let i = 1; i < rowcount + 1; i++) {
                datarow = []
                for (let ii = 1; ii < columncount + 1; ii++) {
                    id = "x" + i + "x" + ii
                    currow = document.querySelectorAll("." + id)
                    if (currow[0].value != "") {
                        datarow.push(currow[0].value)
                    }
                    else {
                        datarow.push('')
                    }
                }
                dataArray.push(datarow)
            }
            console.log(dataArray + ' is dataArray')
            var xhr = new XMLHttpRequest();
            var url = "http://127.0.0.1:5000/data";
            var method = 'POST';

            xhr.open(method, url);
            xhr.setRequestHeader('Access-Control-Allow-Origin', '*')
            xhr.setRequestHeader('Content-Type', 'application/json')
            xhr.onload = function () { console.log(this.response); con()};

            let realdata = JSON.stringify(dataArray)

            xhr.send(realdata);
        }
        function dataget(){
            var xhr = new XMLHttpRequest();
            var url = "http://127.0.0.1:5000/getdata";
            var method = 'POST';

            xhr.open(method, url);
            xhr.setRequestHeader('Access-Control-Allow-Origin', '*')
            xhr.setRequestHeader('Content-Type', 'application/json')
            xhr.onload = function () { oncolli(this.response) };

            let realdata = JSON.stringify('dummydata')

            xhr.send(realdata);
        }
        function oncolli(resp){
            console.log(resp + " is resp")
            //Hier den respstr in ein Array zurück verwandeln und einfügen
            star = false
            wstar = false
            cstar = false
            curword = ""
            currow = []
            fulltable = []
            for(let i=0;i<resp.length;i++){
                if(resp[i]=='"' && star == false){
                    star == true
                }
                else if(resp[i]=='"' && star == true){
                    star == false
                }
                else if(resp[i]=="'" && wstar == false){
                    wstar = true
                }
                else if(resp[i]=="'" && wstar == true){
                    currow.push(curword)
                    curword = ""
                    wstar = false
                }
                else if(resp[i]=="[" && cstar == false){
                    cstar = true
                }
                else if(resp[i]=="]" && cstar == true){
                    fulltable.push(currow)
                    currow = []
                    cstar = false
                }
                else if(wstar == true){
                    curword = curword + resp[i]
                }
            }
            console.log(fulltable)
            loadmyArray(fulltable)
        }
    </script>
    <button onclick="addrow('nor')">Add Row</button>
    <button onclick="addcol('nor')">Add Column</button>
    <button onclick="delrow()">Delete Row</button>
    <button onclick="delcol()">Delete Column</button>
    <button onclick="datasend()">Send to Database</button>
    <button><a href="http://127.0.0.1:5000/myfile.txt" download="">Export this table</a></button>

    <script>
        function deconstruct(id) {
            out = id.toString().charAt(1)
            console.log(id + " is id");
            return out
        }
        function con() {
            dataArray = []
            for (let i = 1; i < rowcount + 1; i++) {
                datarow = []
                for (let ii = 1; ii < columncount + 1; ii++) {
                    id = "x" + i + "x" + ii
                    currow = document.querySelectorAll("." + id)
                    if (currow[0].value != "") {
                        datarow.push(currow[0].value)
                    }
                    else {
                        datarow.push('')
                    }
                }
                dataArray.push(datarow)
            }

            var xhr = new XMLHttpRequest();
            var url = "http://127.0.0.1:5000/login";
            var method = 'POST';

            xhr.open(method, url);
            xhr.setRequestHeader('Access-Control-Allow-Origin', '*')
            xhr.setRequestHeader('Content-Type', 'application/json')

            let realdata = JSON.stringify(dataArray)

            xhr.send(realdata);
            backupArray = dataArray
        }
        function loadArray(mode) {
            if (mode == 'nor') {
                bua = backupArray
                if (rowcount >= bua.length && columncount >= bua[0].length) {
                    console.log('Array fit')
                    for (let i = 1; i < bua.length + 1; i++) {
                        for (let ii = 1; ii < bua[0].length + 1; ii++) {
                            loadid = 'x' + i + 'x' + ii
                            document.querySelectorAll('.' + loadid)[0].value = bua[i - 1][ii - 1]
                        }
                    }
                }
                else {
                    console.log(rowcount + ' is rowcount')
                    console.log(columncount + ' is columncount')
                    console.log(bua.length + ' is bualength')
                    console.log(bua[0].length + ' is bua0length')
                }
                console.log('System loaded')
            }
            else if (mode == 'row') {
                bua = backupArray
                if (rowcount >= bua.length - 1 && columncount >= bua[0].length) {
                    console.log('Array fit')
                    for (let i = 1; i < bua.length; i++) {
                        for (let ii = 1; ii < bua[0].length + 1; ii++) {
                            loadid = 'x' + i + 'x' + ii
                            document.querySelectorAll('.' + loadid)[0].value = bua[i - 1][ii - 1]
                        }
                    }
                }
                else {
                    console.log(rowcount + ' is rowcount')
                    console.log(columncount + ' is columncount')
                    console.log(bua.length + ' is bualength')
                    console.log(bua[0].length + ' is bua0length')
                }
                console.log('System attemtepted to load')
            }
            else if (mode == 'col') {
                bua = backupArray
                if (rowcount >= bua.length && columncount >= bua[0].length - 1) {
                    console.log('Array fit')
                    for (let i = 1; i < bua.length + 1; i++) {
                        for (let ii = 1; ii < bua[0].length; ii++) {
                            loadid = 'x' + i + 'x' + ii
                            document.querySelectorAll('.' + loadid)[0].value = bua[i - 1][ii - 1]
                        }
                    }
                }
                else {
                    console.log(rowcount + ' is rowcount')
                    console.log(columncount + ' is columncount')
                    console.log(bua.length + ' is bualength')
                    console.log(bua[0].length + ' is bua0length')
                }
                console.log('System attemtepted to load')
            }
        }
        function dostart(){
            dataget()
        }
    </script>

    <p ondrop="dosmthfile(event)" ondragover="dosmthdragover(event)">Drag a file here!</p>

    <p>Todo:</p>
    <p>Delete specific rows / columns: Move other data?</p>
    <p>Current /data POST is only meant for updating the data table, a new one needs to be made for interacting with the user table</p>
    <p>Implement login</p>
    <p>Fix input of special characters(Replace unistring with original through js after return? Replace with ae etc. in js before sending?)</p>
    <p>Do a write check at start</p>
    <p>Remove useless linebreaks in early myfiles and linebreaks when elements are left empty in the middle(Save empty spaces as "---" and replace when loaded?)</p>
    <p>Implement dragging element in to update?</p>
    <p>Automatically select gender based on namedata from a database?</p>

</body>

</html>

<!-- 

-->